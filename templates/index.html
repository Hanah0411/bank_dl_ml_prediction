<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Banking Marketing</title>

    <!-- Bootstrap & Plotly -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background: #f5f6fa;
            color: #333;
        }

        .container {
            max-width: 1100px;
        }

        .card {
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: #fff;
        }

        .metric-card {
            border-radius: 10px;
            text-align: center;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        #chart {
            width: 100% !important;
            height: 350px !important;
        }

        #result {
            background: #f8f9fa;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: monospace;
        }

        label {
            font-size: 15px;
            font-weight: 600;
            margin-top: 10px;
            display: block;
        }

        input,
        select {
            margin-top: 5px;
            margin-bottom: 15px;
            border-radius: 6px;
            padding: 10px;
            width: 100%;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="index.html">Banking Marketing</a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/history">Historial</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
 <!-- MÃ‰TRICAS DEL MODELO -->
        <div class="card">
            <h5>MÃ©tricas del Modelo</h5>

            <div class="row g-3 mb-3" id="metricsCards"></div>

            <div class="d-flex align-items-center mb-2">
                <label for="metricsModelSelector" class="me-2">Seleccionar mÃ©tricas:</label>
                <select id="metricsModelSelector" class="form-select w-auto">
                    <option value="ml">Machine Learning</option>
                    <option value="dl">Deep Learning</option>
                </select>
            </div>

            <div id="chart"></div>
        </div>

        <!-- FORMULARIO DE PREDICCIÃ“N -->
        <div class="card">
            <h5>Realizar PredicciÃ³n</h5>

            <form id="predictForm">
                <div id="formFields" class="row g-2"></div>

                <label class="mt-2">Elegir modelo:</label>
                <select id="modelSelector" class="form-select mb-3" required>
                    <option value="">Seleccionar modelo...</option>
                    <option value="ml">Machine Learning</option>
                    <option value="dl">Deep Learning</option>
                </select>

                <button class="btn btn-primary w-100" type="submit">Realizar PredicciÃ³n</button>
            </form>
        </div>

        <!-- RESULTADO -->
        <div id="result">ðŸ“Œ Resultado aparecerÃ¡ aquÃ­...</div>
    </div>



<script>

    /* -------------------- CAMPOS DEL FORMULARIO -------------------- */
    const labels_es = {
        age: 'Edad', job: 'Trabajo', marital: 'Estado civil', education: 'Nivel educativo',
        default: 'CrÃ©dito en mora', balance: 'Balance en cuenta',
        housing: 'CrÃ©dito hipotecario', loan: 'CrÃ©dito personal',
        contact: 'Tipo de contacto', day: 'DÃ­a del mes', month: 'Mes',
        duration: 'DuraciÃ³n de la llamada (seg)', campaign: 'NÂº de contactos',
        pdays: 'DÃ­as desde Ãºltimo contacto', previous: 'Contactos previos',
        poutcome: 'Resultado previo'
    };

    const fields = Object.keys(labels_es);

    const categorical = {
        job: ['admin.', 'unknown', 'unemployed', 'management', 'housemaid', 'entrepreneur', 'student', 'blue-collar', 'self-employed', 'retired', 'technician', 'services'],
        marital: ['married', 'divorced', 'single', 'unknown'],
        education: ['secondary', 'tertiary', 'primary', 'unknown'],
        default: ['no', 'yes', 'unknown'],
        housing: ['no', 'yes'],
        loan: ['no', 'yes'],
        contact: ['unknown', 'telephone', 'cellular'],
        month: ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'],
        poutcome: ['unknown','other','failure','success']
    };

    const formDiv = document.getElementById('formFields');

    fields.forEach(f => {
        const label = document.createElement('label');
        label.textContent = labels_es[f];
        formDiv.appendChild(label);

        if (categorical[f]) {
            const sel = document.createElement('select');
            sel.name = f;
            sel.required = true;
            categorical[f].forEach(opt => sel.add(new Option(opt, opt)));
            formDiv.appendChild(sel);
        } else {
            const input = document.createElement('input');
            input.type = "number";
            input.name = f;
            input.required = true;
            formDiv.appendChild(input);
        }
    });


    /* -------------------- PREDICCIÃ“N -------------------- */
    document.getElementById('predictForm').addEventListener('submit', async e => {
        e.preventDefault();

        const model = document.getElementById("modelSelector").value;
        if (!model) return alert("âš ï¸ Selecciona el modelo");

        const endpoint = model === "ml" ? "/predict-ml" : "/predict-dl";

        const inputData = {};
        fields.forEach(f => {
            const val = document.getElementsByName(f)[0].value;
            inputData[f] = isNaN(val) || categorical[f] ? val : Number(val);
        });

        const res = await fetch(endpoint, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({input: inputData})
        });

        const data = await res.json();
        const resultDiv = document.getElementById("result");

        if (data.error) {
            resultDiv.innerHTML = `<span style="color: red"><b>âš  Error:</b> ${data.error}</span>`;
            return;
        }

        resultDiv.innerHTML = `
            ðŸ§  <b>Modelo:</b> ${data.used_model}<br>
            ðŸ“ˆ <b>PredicciÃ³n:</b> ${data.prediction == 1 ? "SÃ­ contratarÃ¡" : "No contratarÃ¡"}<br>
            ðŸ”¢ <b>Probabilidad:</b> ${(data.probability * 100).toFixed(2)}%
        `;
    });


    /* -------------------- MÃ‰TRICAS DESDE FLASK -------------------- */
    async function loadMetrics() {
        const model = document.getElementById('metricsModelSelector').value;

        const res = await fetch(`/metrics?model=${model}`);
        const metrics = await res.json();

        const container = document.getElementById('metricsCards');
        container.innerHTML = "";

        for (let key in metrics) {
            container.innerHTML += `
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-title">${key.toUpperCase()}</div>
                        <div class="metric-value">${metrics[key]}</div>
                    </div>
                </div>
            `;
        }

        Plotly.newPlot('chart', [{
            x: Object.keys(metrics),
            y: Object.values(metrics),
            type: 'bar'
        }]);
    }

    document.getElementById("metricsModelSelector")
        .addEventListener("change", loadMetrics);

    loadMetrics();

</script>

</body>
</html>

